â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸš€ DEPLOYMENT GUIDE - Multi-KB System with SuperAdmin          â•‘
â•‘  Status: âœ… READY TO DEPLOY                                      â•‘
â•‘  Date: October 19, 2025                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ“‹ WHAT'S INCLUDED

âœ… 6 Domains:
   â€¢ global (shared knowledge base)
   â€¢ staff (staff.vapeshed.co.nz)
   â€¢ web (www.vapeshed.co.nz)
   â€¢ gpt (gpt.ecigdis.co.nz)
   â€¢ wiki (wiki.vapeshed.co.nz)
   â€¢ superadmin (superadmin.vapeshed.co.nz) â­ NEW - sees EVERYTHING

âœ… 10 Inheritance Links:
   â€¢ staff â†’ global
   â€¢ web â†’ global
   â€¢ gpt â†’ global
   â€¢ wiki â†’ global
   â€¢ wiki â†’ staff
   â€¢ superadmin â†’ global (priority 100)
   â€¢ superadmin â†’ staff (priority 90)
   â€¢ superadmin â†’ web (priority 80)
   â€¢ superadmin â†’ gpt (priority 70)
   â€¢ superadmin â†’ wiki (priority 60)

âœ… 10 Tables:
   â€¢ 2 registry tables (domain config)
   â€¢ 8 KB tables with domain_key column

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ¯ DEPLOYMENT SCENARIOS

Choose your scenario:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 1: Fresh Installation (No Existing Tables)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Deploy everything
  cd /home/master/applications/jcepnzzkmj/public_html/ai-agent/database
  mysql -u jcepnzzkmj -pwprKh9Jq63 jcepnzzkmj < deploy-multi-kb-single-table.sql

Step 2: Verify
  mysql -u jcepnzzkmj -pwprKh9Jq63 jcepnzzkmj -e "
      SELECT domain_key, domain_name FROM ai_kb_domain_registry;
  "
  Expected: 6 domains (global, staff, web, gpt, wiki, superadmin)

Time: 30 seconds
Risk: ZERO

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 2: Existing Tables (Already Have ai_kb_* tables)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ YOUR SITUATION (based on error logs)

Step 1: Migrate existing tables (add domain_key column)
  cd /home/master/applications/jcepnzzkmj/public_html/ai-agent/database
  mysql -u jcepnzzkmj -pwprKh9Jq63 jcepnzzkmj < migrate-existing-kb-tables.sql

  What this does:
  â€¢ Adds domain_key VARCHAR(50) NOT NULL DEFAULT 'global' to 8 tables
  â€¢ All existing data gets domain_key='global'
  â€¢ Adds indexes on domain_key
  â€¢ Adds foreign keys if registry exists

Step 2: Deploy registry and complete the system
  mysql -u jcepnzzkmj -pwprKh9Jq63 jcepnzzkmj < deploy-multi-kb-single-table.sql

  What this does:
  â€¢ Creates ai_kb_domain_registry (6 domains)
  â€¢ Creates ai_kb_domain_inheritance (10 links)
  â€¢ Creates stored procedures
  â€¢ Seeds initial data

Step 3: Verify
  mysql -u jcepnzzkmj -pwprKh9Jq63 jcepnzzkmj -e "
      SELECT domain_key, COUNT(*) FROM ai_kb_knowledge_items GROUP BY domain_key;
      SELECT domain_key, domain_name FROM ai_kb_domain_registry;
  "

Time: 2 minutes
Risk: LOW (adds columns with defaults, preserves data)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 3: Clean Slate (Drop Everything and Start Fresh)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ WARNING: This deletes all existing KB data!

Step 1: Drop existing tables
  mysql -u jcepnzzkmj -pwprKh9Jq63 jcepnzzkmj << 'SQL'
  DROP TABLE IF EXISTS ai_kb_rate_limits;
  DROP TABLE IF EXISTS ai_kb_errors;
  DROP TABLE IF EXISTS ai_kb_sync_history;
  DROP TABLE IF EXISTS ai_kb_config;
  DROP TABLE IF EXISTS ai_kb_performance_metrics;
  DROP TABLE IF EXISTS ai_kb_conversations;
  DROP TABLE IF EXISTS ai_kb_queries;
  DROP TABLE IF EXISTS ai_kb_knowledge_items;
  DROP TABLE IF EXISTS ai_kb_domain_inheritance;
  DROP TABLE IF EXISTS ai_kb_domain_registry;
  SQL

Step 2: Deploy everything fresh
  mysql -u jcepnzzkmj -pwprKh9Jq63 jcepnzzkmj < deploy-multi-kb-single-table.sql

Step 3: Verify
  mysql -u jcepnzzkmj -pwprKh9Jq63 jcepnzzkmj -e "
      SHOW TABLES LIKE 'ai_kb_%';
  "
  Expected: 10 tables

Time: 1 minute
Risk: HIGH (data loss)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ¯ RECOMMENDED FOR YOU: SCENARIO 2

Based on your error logs, you have existing tables without domain_key.

Run these commands in order:

1ï¸âƒ£ Migrate existing tables:
   mysql -u jcepnzzkmj -pwprKh9Jq63 jcepnzzkmj < migrate-existing-kb-tables.sql

2ï¸âƒ£ Deploy registry:
   mysql -u jcepnzzkmj -pwprKh9Jq63 jcepnzzkmj < deploy-multi-kb-single-table.sql

3ï¸âƒ£ Verify deployment:
   mysql -u jcepnzzkmj -pwprKh9Jq63 jcepnzzkmj -e "
       SELECT 'Registry:' as check_type, COUNT(*) as count FROM ai_kb_domain_registry
       UNION ALL
       SELECT 'Inheritance:', COUNT(*) FROM ai_kb_domain_inheritance
       UNION ALL
       SELECT 'Knowledge Items:', COUNT(*) FROM ai_kb_knowledge_items;
   "

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ’¡ USAGE EXAMPLES

After deployment:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Search from GLOBAL (shared knowledge only)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
CALL sp_ai_kb_search_with_inheritance('global', 'policy', 10);
â†’ Returns only global knowledge

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Search from STAFF (staff + global)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
CALL sp_ai_kb_search_with_inheritance('staff', 'inventory', 10);
â†’ Returns staff knowledge + inherited global knowledge

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Search from WIKI (wiki + staff + global)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
CALL sp_ai_kb_search_with_inheritance('wiki', 'procedure', 10);
â†’ Returns wiki + staff + global knowledge

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Search from SUPERADMIN (EVERYTHING!) â­                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
CALL sp_ai_kb_search_with_inheritance('superadmin', 'any query', 20);
â†’ Returns knowledge from ALL domains:
   superadmin (priority 1)
   global (priority 100)
   staff (priority 90)
   web (priority 80)
   gpt (priority 70)
   wiki (priority 60)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Add new domain dynamically (no schema changes!)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
CALL sp_ai_kb_add_domain(
    'suppliers',
    'suppliers.vapeshed.co.nz',
    'Supplier Portal',
    '["global"]'
);
â†’ New domain ready instantly!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ“Š POST-DEPLOYMENT VERIFICATION

Run this to confirm everything is working:

mysql -u jcepnzzkmj -pwprKh9Jq63 jcepnzzkmj << 'SQL'

-- Check domains
SELECT '=== DOMAINS ===' as check;
SELECT domain_key, domain_name, application_name, kb_scope 
FROM ai_kb_domain_registry 
ORDER BY CASE domain_key 
    WHEN 'global' THEN 1
    WHEN 'staff' THEN 2
    WHEN 'web' THEN 3
    WHEN 'gpt' THEN 4
    WHEN 'wiki' THEN 5
    WHEN 'superadmin' THEN 6
END;

-- Check inheritance
SELECT '' as '';
SELECT '=== INHERITANCE ===' as check;
SELECT child_domain, parent_domain, inheritance_priority
FROM ai_kb_domain_inheritance
ORDER BY child_domain, inheritance_priority DESC;

-- Check procedures
SELECT '' as '';
SELECT '=== PROCEDURES ===' as check;
SHOW PROCEDURE STATUS WHERE Db = DATABASE() AND Name LIKE 'sp_ai_kb_%';

-- Test search (should work even with no data)
SELECT '' as '';
SELECT '=== TEST SEARCH ===' as check;
CALL sp_ai_kb_search_with_inheritance('superadmin', 'test', 5);

SQL

Expected output:
  âœ… 6 domains
  âœ… 10 inheritance links
  âœ… 2 procedures
  âœ… Search returns (empty is OK if no data yet)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ‰ SUCCESS CRITERIA

After deployment, you should be able to:

âœ… See 6 domains in ai_kb_domain_registry
âœ… See 10 inheritance links in ai_kb_domain_inheritance
âœ… Call sp_ai_kb_search_with_inheritance('superadmin', 'test', 10)
âœ… Add new domains via sp_ai_kb_add_domain()
âœ… Insert knowledge items with domain_key
âœ… Search from any domain and get inherited results

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ†˜ TROUBLESHOOTING

Problem: "Unknown column 'domain_key'"
Solution: Run migrate-existing-kb-tables.sql first

Problem: "Foreign key constraint fails"
Solution: Run deploy-multi-kb-single-table.sql to create registry

Problem: "Table already exists"
Solution: That's OK! Script uses CREATE TABLE IF NOT EXISTS

Problem: "Can't create view"
Solution: That's OK! Views will be created after migration

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ“ NEXT STEPS

1. Choose your scenario above
2. Run the commands
3. Verify with the verification script
4. Start using the multi-domain KB system!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Questions? Review the comprehensive docs in /ai-agent/ directory
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
